# dvlad

Work-in-progress Python reimplementation of the DenseVLAD baseline from:
*A. Torii, R. Arandjelović, J. Sivic, M. Okutomi, T. Pajdla — “24/7 Place Recognition by View Synthesis”, CVPR 2015.*

Initial focus: exact replication of Torii15 DenseVLAD pipeline and assets.

## Notes on dependencies

On osx-arm64, use pixi to install the conda-forge environment and then
reinstall `cyvlfeat` against the patched VLFeat 0.9.20 build:
```
pixi install -e dev
pixi run build-vlfeat
pixi run install-cyvlfeat
pixi run install-dvlad
```

If you are not using pixi, `cyvlfeat` requires the VLFeat C library (headers
and `libvl`) to be installed on your system. On Apple Silicon, build VLFeat
from source with SSE/AVX disabled and set include/library paths when
installing `cyvlfeat`.

Example (paths vary):
```
CFLAGS="-I/path/to/vlfeat" LDFLAGS="-L/path/to/vlfeat/bin/maci64" \
  pip install cyvlfeat
```

For Apple Silicon without Rosetta, `scripts/build_vlfeat_arm64.sh` can
download + patch VLFeat 0.9.20, build `libvl`, and print the exact
environment variables needed to install `cyvlfeat`.

## Parity status

Stage-by-stage parity against MATLAB dumps is exact for:
- preprocessing (downscale + grayscale)
- imsmooth
- DSIFT (all scales)
- PHOW concatenation
- RootSIFT
- kd-tree assignments
- grid masking (example_grid)

Remaining parity checks:
- PCA/whitening vector vs pinned golden vector

Note: the shipped `example_gsv` and `example_grid` `.dict_grid.dnsvlad.mat`
files do not match the MATLAB code outputs in this environment
(R2025b + VLFeat 0.9.20). The MATLAB outputs differ by:
- example_gsv: 254 elements > 1e-4, max diff ~0.021669
- example_grid: 9370 elements > 1e-4, max diff ~0.020278

## Shipped `.mat` mismatch investigation

We attempted to reproduce the shipped `*.dict_grid.dnsvlad.mat` vectors exactly.
Current Python matches MATLAB (R2025b + VLFeat 0.9.20) stage-for-stage, but
the shipped `.mat` files differ:
- example_gsv `_012_000`: mean |Δ| ~8.33e-5, L2 diff ~0.108, cosine ~0.994,
  max |Δ| ~0.0217, 254 dims > 1e-4 (differences concentrated in 2 clusters).
- example_grid `_012_000`: mean |Δ| ~4.18e-4, L2 diff ~0.150, cosine ~0.989,
  max |Δ| ~0.0203, 9370 dims > 1e-4.

Variants tested (none matched the shipped vectors):
- VLFeat 0.9.19 vs 0.9.20, arm64 build vs x86_64 (Rosetta) binary.
- PHOW options (fast/float, step), bounds offsets, magnification/window size,
  contrast threshold, quantization path.
- kd-tree vs brute assignments; float32 vs float64 normalization.
- grid masking variants (dilation, center-only, multi-sample, plane/no-plane).

Conclusion: the shipped `.mat` files were likely generated in a different
environment (e.g., MATLAB R2015a/2013b on Intel, or a different VLFeat build
or grid masking variant). For exact shipped parity, we need the original
environment or intermediate dumps from the authors' setup.

## MATLAB dump (strict tests)

The stage parity tests require a MATLAB dump generated by
`scripts/matlab/dump_densevlad.m`. It writes:
`~/Library/Caches/dvlad/torii15/matlab_dump/densevlad_dump.mat`.

Masked grid parity uses:
`scripts/matlab/dump_densevlad_grid.m`, which writes:
`~/Library/Caches/dvlad/torii15/matlab_dump/densevlad_grid_dump.mat`.

The repo ships a MATLAB-normalized centers asset at:
`src/dvlad/torii15/data/dnscnt_RDSIFT_K128.cx_norm.npy`.
This is the exact `CX` after MATLAB normalization, so kd-tree assignments
match bit-for-bit without a local cache.

To regenerate or verify the shipped asset from a local MATLAB dump:
```
pixi run -e dev python scripts/generate_cx_norm.py --verify
```

If you generate a dump locally, the same normalized `CX` is also cached at:
`~/Library/Caches/dvlad/torii15/247code/data/dnscnt_RDSIFT_K128.cx_norm.npy`.
