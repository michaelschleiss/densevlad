# dvlad

Work-in-progress Python reimplementation of the DenseVLAD baseline from:
*A. Torii, R. Arandjelović, J. Sivic, M. Okutomi, T. Pajdla — “24/7 Place Recognition by View Synthesis”, CVPR 2015.*

Initial focus: exact replication of Torii15 DenseVLAD pipeline and assets.

## Notes on dependencies

On osx-arm64, use pixi to install the conda-forge environment and then
reinstall `cyvlfeat` against the patched VLFeat 0.9.20 build:
```
pixi install -e dev
pixi run build-vlfeat
pixi run install-cyvlfeat
pixi run install-dvlad
```

If you are not using pixi, `cyvlfeat` requires the VLFeat C library (headers
and `libvl`) to be installed on your system. On Apple Silicon, build VLFeat
from source with SSE/AVX disabled and set include/library paths when
installing `cyvlfeat`.

Example (paths vary):
```
CFLAGS="-I/path/to/vlfeat" LDFLAGS="-L/path/to/vlfeat/bin/maci64" \
  pip install cyvlfeat
```

For Apple Silicon without Rosetta, `scripts/build_vlfeat_arm64.sh` can
download + patch VLFeat 0.9.20, build `libvl`, and print the exact
environment variables needed to install `cyvlfeat`.

## Parity status

Stage-by-stage parity against MATLAB dumps is exact for:
- preprocessing (downscale + grayscale)
- imsmooth
- DSIFT (all scales)
- PHOW concatenation
- RootSIFT
- kd-tree assignments

Remaining parity checks:
- pre-PCA VLAD vs shipped `.dict_grid.dnsvlad.mat`
- PCA/whitening vector vs pinned golden vector

## MATLAB dump (strict tests)

The stage parity tests require a MATLAB dump generated by
`scripts/matlab/dump_densevlad.m`. It writes:
`~/Library/Caches/dvlad/torii15/matlab_dump/densevlad_dump.mat`.

When the dump is present, the normalized centers (`CX`) are cached as:
`~/Library/Caches/dvlad/torii15/247code/data/dnscnt_RDSIFT_K128.cx_norm.npy`
so kd-tree assignments match MATLAB bit-for-bit.
