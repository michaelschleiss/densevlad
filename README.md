# densevlad

Work-in-progress Python reimplementation of the DenseVLAD baseline from:
*A. Torii, R. Arandjelović, J. Sivic, M. Okutomi, T. Pajdla — “24/7 Place Recognition by View Synthesis”, CVPR 2015.*

Initial focus: exact replication of Torii15 DenseVLAD pipeline and assets.

## Notes on dependencies

On linux-64, use pixi to build VLFeat from the submodule and install the
clean cyvlfeat submodule:
```
pixi install -e dev
pixi run build-vlfeat-linux
pixi run install-cyvlfeat-linux
pixi run install-densevlad-linux
```
Then load the environment before running tests:
```
source .pixi/vlfeat_env_linux.sh
```

On osx-arm64, the reference workflow uses pixi and the arm64 helper scripts
under `scripts/build/arm64/` (kept for later):
```
pixi install -e dev
pixi run build-vlfeat-arm64
pixi run install-cyvlfeat-arm64
pixi run install-densevlad-arm64
```

For Apple Silicon without Rosetta, `scripts/build/arm64/build_vlfeat_arm64.sh` can
build `libvl` with `sse2neon` and print the environment variables needed to
install `cyvlfeat`. This is reference-only and not part of the default
linux/x86 path.

If you cloned without submodules:
```
git submodule update --init --recursive
```

To download required assets (247code + full Tokyo247 dbStruct/queries/database),
run:
```
python scripts/download_assets.py
```

Tests do not download Tokyo247 assets. Run `python scripts/download_assets.py`
before running pytest. The Tokyo247 golden test requires the specific images
listed in `./assets/torii15/matlab_dump/tokyo247_golden_list.txt`.

The repo includes a clean `thirdparty/cyvlfeat` submodule pinned at
v0.7.1-densevlad and the workflow installs `cyvlfeat` from that submodule.
An optional reference patch lives at
`scripts/reference/cyvlfeat/patch_cyvlfeat_sdist.py` and adds C-level
permute/contrast handling for faster PHOW; to apply it in the arm64 helper,
set `DVLAD_PATCH_CYVLFEAT=1`.

To force exact scalar math (used by strict parity tests), set:
`DVLAD_DISABLE_SIMD=1`.

## Parity status

Stage-by-stage parity against MATLAB dumps is exact for:
- preprocessing (downscale + grayscale)
- imsmooth
- DSIFT (all scales)
- PHOW concatenation
- RootSIFT
- kd-tree assignments

Remaining parity checks:
- PCA/whitening vector vs pinned golden vector

## Example asset

`example_gsv` is the example Google Street View image shipped with the
authors' `247code.zip` and used by `test_densevlad.m`:
`247code/data/example_gsv/L-NLvGeZ6JHX6JO8Xnf_BA_012_000.jpg`.

The shipped `example_gsv` `.dict_grid.dnsvlad.mat` vectors match MATLAB
bit-for-bit when generated with MATLAB R2015b + VLFeat 0.9.20.

## MATLAB dump (strict tests)

The stage parity tests require a MATLAB dump generated by
`scripts/dump_densevlad_all.m` (mode `densevlad`). It writes:
`./assets/torii15/matlab_dump/densevlad_dump.mat`.

Tokyo247 golden references use:
`scripts/dump_densevlad_all.m` (mode `tokyo247`), which writes:
- `./assets/torii15/matlab_dump/tokyo247_golden.mat`
- `./assets/torii15/matlab_dump/tokyo247_golden_list.txt`

The golden set samples 5 DB + 5 query images (seed 1337), resizes to max 640
pixels (paper setting), and stores both pre-PCA VLAD (16384-D) and
PCA-whitened VLAD (4096-D) for parity tests.

The repo ships a MATLAB-normalized centers asset at:
`src/densevlad/torii15/data/dnscnt_RDSIFT_K128.cx_norm.npy`.
This is the exact `CX` after MATLAB normalization, so kd-tree assignments
match bit-for-bit without a local cache.

Dense assignment defaults to `matmul` (vectorized exact L2 with deterministic
zero-descriptor tie handling) and is usually identical to kd-tree, but rare
tie cases can differ. For strict parity tests and paper matching, use
`DVLAD_ASSIGN_METHOD=kdtree`. For an alternative fast path that may diverge,
set `DVLAD_ASSIGN_METHOD=kmeans`. The matmul block size can be tuned with
`DVLAD_MATMUL_BLOCK` (default 8192).

## Performance notes

Tokyo247 golden (10 images, max_dim=640, imdown=false), Apple Silicon, single
core, NEON enabled:
```
stage         Python kdtree   Python matmul
read          0.108 s         0.109 s
phow          0.076 s         0.076 s
rootsift      0.041 s         0.040 s
assignment    1.810 s         0.205 s
vlad          0.006 s         0.005 s
total         2.040 s         0.435 s
```
PHOW is ~5x faster than the original baseline after NEON dsift + C-level
permutation/contrast thresholding. The kd-tree query still dominates the
exact path. The matmul path (BLAS) cuts assignment time by ~9x and delivers
~4.7x end-to-end speedup, but can differ in rare tie cases (observed
1 descriptor mismatch out of 10 golden images, max VLAD diff ~5.5e-05).
Use `DVLAD_ASSIGN_METHOD=kdtree` for strict parity.

## Validation pipeline (end-to-end)

This is the full validation workflow used to assert parity.

1) **Fetch assets**
- Run `python scripts/download_assets.py` to download 247code plus the full
  Tokyo247 dbStruct/queries/database into `./assets/torii15/...`.

2) **Build VLFeat + cyvlfeat**
- Linux (pixi):
```
pixi install -e dev
pixi run build-vlfeat-linux
pixi run install-cyvlfeat-linux
pixi run install-densevlad-linux
```
- Apple Silicon (pixi, reference-only):
```
pixi install -e dev
pixi run build-vlfeat-arm64
pixi run install-cyvlfeat-arm64
pixi run install-densevlad-arm64
```
- Ensure `libvl` is discoverable before running tests:
```
source .pixi/vlfeat_env_linux.sh
```
or (arm64 reference):
```
source .pixi/vlfeat_env.sh
```

3) **Generate MATLAB dumps**
- DenseVLAD baseline (example_gsv):
```
/Applications/MATLAB_R2025b.app/bin/matlab -batch "run('scripts/dump_densevlad_all.m'); dump_densevlad_all('densevlad')"
```
- Outputs:
  - `./assets/torii15/matlab_dump/densevlad_dump.mat`

4) **Stage-by-stage parity tests (strict, exact match)**
- Covers preprocessing, imsmooth, DSIFT per scale, PHOW concat, RootSIFT,
  and kd-tree assignments.
```
source .pixi/vlfeat_env.sh
python -m pytest tests/test_torii15_stage_parity.py -q
```
- Tests read MATLAB v7.3 dumps via `h5py` and use exact array equality.

5) **Pre-PCA VLAD parity tests**
- Compares Python DenseVLAD against the MATLAB dumps for example_gsv `_012_000`.
```
source .pixi/vlfeat_env.sh
python -m pytest tests/test_torii15_pre_pca_vlad.py -q
```

6) **Whitening (golden vector)**
- Uses the shipped PCA assets plus a pinned golden DenseVLAD vector
  (base64 in `tests/test_torii15_whitening.py`) to avoid loading the ~1GB
  PCA matrix in unit tests.
```
python -m pytest tests/test_torii15_whitening.py -q
```

7) **Shipped `.dict_grid.dnsvlad.mat` comparison (strict)**
- Uses the shipped `example_gsv` vectors and compares them to MATLAB dumps.
```
python -m pytest tests/test_torii15_shipped_parity.py -q
```

## MATLAB baseline (Tokyo 24/7)

To run the baseline in MATLAB (without Image Processing Toolbox), use:
```
/Applications/MATLAB_R2025b.app/bin/matlab -batch \
  "addpath('scripts'); eval_tokyo247_densevlad('limit_db',10,'limit_q',5,'force',true)"
```

This uses `scripts/im2single.m` as a fallback so the code runs
without the toolbox. Remove the limits for a full run (note: this is
slow; DenseVLAD is ~30s/image on CPU in MATLAB).

By default the MATLAB evaluator resizes images to max dimension 640 and
does not apply `vl_imdown`. You can override these with:
`'max_dim', 0` (disable resize) and `'use_imdown', true`.

## Tokyo 24/7 baseline evaluation (Figure 6)

This reproduces the DenseVLAD baseline recall@N on the 24/7-Tokyo dataset
using the query subset from the paper (315 images).

### Dataset downloads

Database images (GSV) and queries are mirrored by the NetVLAD project:
`https://data.ciirc.cvut.cz/public/projects/2015netVLAD/Tokyo247/`.

Run:
```
python scripts/download_assets.py
```
This downloads:
1) **Database (75,984 images, ~40GB)** into
`./assets/torii15/tokyo247/database_gsv_vga/03814/...`
2) **Full queries (247query_v3.zip)** into `./assets/torii15/queries/`
3) **dbStruct metadata (tokyo247.mat)** into `./assets/torii15/tokyo247/`

The dbStruct lists `.jpg` paths, but the database is shipped as `.png`;
the evaluator maps `.jpg` -> `.png` automatically.

### Run DenseVLAD baseline

```
source .pixi/vlfeat_env.sh
python scripts/eval_tokyo247_densevlad.py
```

Descriptor caches are stored at:
`./assets/torii15/tokyo247/densevlad_cache/`.

The evaluator resizes images so the maximum dimension is 640 by default
(`--max-dim 640`), matching the paper. Use `--use-imdown` to append the
extra `vl_imdown` step from the released MATLAB code.

Descriptor extraction supports parallel workers. By default the evaluator
uses up to 4 processes; override with `--workers N` (and optionally
`--worker-chunksize` for task batching).

You can override dataset locations for the evaluator via CLI flags:
`--dbstruct`, `--db-dir`, `--query-dir`, and `--out-dir`.
