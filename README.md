# dvlad

Work-in-progress Python reimplementation of the DenseVLAD baseline from:
*A. Torii, R. Arandjelović, J. Sivic, M. Okutomi, T. Pajdla — “24/7 Place Recognition by View Synthesis”, CVPR 2015.*

Initial focus: exact replication of Torii15 DenseVLAD pipeline and assets.

## Notes on dependencies

On osx-arm64, use pixi to install the conda-forge environment and then
reinstall `cyvlfeat` against the patched VLFeat 0.9.20 build:
```
pixi install -e dev
pixi run build-vlfeat
pixi run install-cyvlfeat
pixi run install-dvlad
```

If you are not using pixi, `cyvlfeat` requires the VLFeat C library (headers
and `libvl`) to be installed on your system. On Apple Silicon, build VLFeat
from source with SSE/AVX disabled and set include/library paths when
installing `cyvlfeat`.

Example (paths vary):
```
CFLAGS="-I/path/to/vlfeat" LDFLAGS="-L/path/to/vlfeat/bin/maci64" \
  pip install cyvlfeat
```

For Apple Silicon without Rosetta, `scripts/build_vlfeat_arm64.sh` can
download + patch VLFeat 0.9.20, build `libvl`, and print the exact
environment variables needed to install `cyvlfeat`.

## Parity status

Stage-by-stage parity against MATLAB dumps is exact for:
- preprocessing (downscale + grayscale)
- imsmooth
- DSIFT (all scales)
- PHOW concatenation
- RootSIFT
- kd-tree assignments
- grid masking (example_grid)

Remaining parity checks:
- PCA/whitening vector vs pinned golden vector

Note: the shipped `example_gsv` and `example_grid` `.dict_grid.dnsvlad.mat`
files do not match the MATLAB code outputs in this environment
(R2025b + VLFeat 0.9.20). The MATLAB outputs differ by:
- example_gsv: 254 elements > 1e-4, max diff ~0.021669
- example_grid: 9370 elements > 1e-4, max diff ~0.020278

## Shipped `.mat` mismatch investigation

We attempted to reproduce the shipped `*.dict_grid.dnsvlad.mat` vectors exactly.
Current Python matches MATLAB (R2025b + VLFeat 0.9.20) stage-for-stage, but
the shipped `.mat` files differ:
- example_gsv `_012_000`: mean |Δ| ~8.33e-5, L2 diff ~0.108, cosine ~0.994,
  max |Δ| ~0.0217, 254 dims > 1e-4 (differences concentrated in 2 clusters).
- example_grid `_012_000`: mean |Δ| ~4.18e-4, L2 diff ~0.150, cosine ~0.989,
  max |Δ| ~0.0203, 9370 dims > 1e-4.

Variants tested (none matched the shipped vectors):
- VLFeat 0.9.19 vs 0.9.20, arm64 build vs x86_64 (Rosetta) binary.
- PHOW options (fast/float, step), bounds offsets, magnification/window size,
  contrast threshold, quantization path.
- kd-tree vs brute assignments; float32 vs float64 normalization.
- grid masking variants (dilation, center-only, multi-sample, plane/no-plane).

Conclusion: the shipped `.mat` files were likely generated in a different
environment (e.g., MATLAB R2015a/2013b on Intel, or a different VLFeat build
or grid masking variant). For exact shipped parity, we need the original
environment or intermediate dumps from the authors' setup.

## MATLAB dump (strict tests)

The stage parity tests require a MATLAB dump generated by
`scripts/matlab/dump_densevlad.m`. It writes:
`~/Library/Caches/dvlad/torii15/matlab_dump/densevlad_dump.mat`.

Masked grid parity uses:
`scripts/matlab/dump_densevlad_grid.m`, which writes:
`~/Library/Caches/dvlad/torii15/matlab_dump/densevlad_grid_dump.mat`.

The repo ships a MATLAB-normalized centers asset at:
`src/dvlad/torii15/data/dnscnt_RDSIFT_K128.cx_norm.npy`.
This is the exact `CX` after MATLAB normalization, so kd-tree assignments
match bit-for-bit without a local cache.

To regenerate or verify the shipped asset from a local MATLAB dump:
```
pixi run -e dev python scripts/generate_cx_norm.py --verify
```

If you generate a dump locally, the same normalized `CX` is also cached at:
`~/Library/Caches/dvlad/torii15/247code/data/dnscnt_RDSIFT_K128.cx_norm.npy`.

## Validation pipeline (end-to-end)

This is the full validation workflow used to assert parity.

1) **Fetch assets**
- The code downloads `247code.zip` from the authors to
  `~/Library/Caches/dvlad/torii15/247code.zip` on first use.
- Tests and scripts use `Torii15Assets.default()` to pull files from the zip
  into `~/Library/Caches/dvlad/torii15/247code/...`.

2) **Build VLFeat + cyvlfeat**
- Apple Silicon (pixi):
```
pixi install -e dev
pixi run build-vlfeat
pixi run install-cyvlfeat
pixi run install-dvlad
```
- Ensure `libvl` is discoverable before running tests:
```
source .pixi/vlfeat_env.sh
```

3) **Generate MATLAB dumps**
- DenseVLAD baseline (example_gsv):
```
/Applications/MATLAB_R2025b.app/bin/matlab -batch "run('scripts/matlab/dump_densevlad.m')"
```
- DenseVLAD with grid masking (example_grid):
```
/Applications/MATLAB_R2025b.app/bin/matlab -batch "run('scripts/matlab/dump_densevlad_grid.m')"
```
- Outputs:
  - `~/Library/Caches/dvlad/torii15/matlab_dump/densevlad_dump.mat`
  - `~/Library/Caches/dvlad/torii15/matlab_dump/densevlad_grid_dump.mat`

4) **Stage-by-stage parity tests (strict, exact match)**
- Covers preprocessing, imsmooth, DSIFT per scale, PHOW concat, RootSIFT,
  kd-tree assignments, and grid mask.
```
source .pixi/vlfeat_env.sh
python -m pytest tests/test_torii15_stage_parity.py -q
```
- Tests read MATLAB v7.3 dumps via `h5py` and use exact array equality.

5) **Pre-PCA VLAD parity tests**
- Compares Python DenseVLAD against the MATLAB dumps for:
  - example_gsv `_012_000`
  - example_grid `_012_000` (masked)
```
source .pixi/vlfeat_env.sh
python -m pytest tests/test_torii15_pre_pca_vlad.py -q
```

6) **Whitening (golden vector)**
- Uses the shipped PCA assets plus a pinned golden DenseVLAD vector
  (base64 in `tests/test_torii15_whitening.py`) to avoid loading the ~1GB
  PCA matrix in unit tests.
```
python -m pytest tests/test_torii15_whitening.py -q
```

7) **Shipped `.dict_grid.dnsvlad.mat` comparison (informational)**
- We do *not* use the shipped `.mat` files for parity tests because they do not
  match MATLAB outputs in this environment; see the “Shipped `.mat` mismatch
  investigation” section for metrics and attempted fixes.
